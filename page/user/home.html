<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Home</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
    <div class="flex justify-between items-center bg-white p-4 shadow">
        <h1 class="text-xl font-bold" id="tokenname">File Manager</h1>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition cursor-pointer">
            Logout
        </button>
    </div>

    <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏™‡πà‡∏ß‡∏ô upload + ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) -->
    <div class="max-w-4xl mx-auto p-6">
            <!-- ‡∏™‡πà‡∏ß‡∏ô Upload -->
    <div class="bg-white p-6 rounded-2xl shadow mb-6">
        <h2 class="text-lg font-bold mb-4">Upload File</h2>
        <input type="file" id="fileInput" class="mb-4">
        <img id="preview" class="max-w-xs mb-4 hidden rounded-lg">
        <iframe id="previewPdf" class="w-full h-64 mb-4 hidden rounded-lg border"></iframe>
        <div id="previewOther" class="mb-4 hidden p-4 bg-gray-50 rounded-lg border text-center">
            <span class="text-4xl">üìÑ</span>
            <p id="previewFilename" class="text-sm text-gray-600 mt-2"></p>
        </div>
        <br>
        <button id="uploadBtn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition cursor-pointer">
            Upload
        </button>
    </div>
    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå -->
    <div class="bg-white p-6 rounded-2xl shadow">
        <h2 class="text-lg font-bold mb-4">My Files</h2>
        <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå..." class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <table class="w-full">
            <thead>
                <tr class="border-b">
                    <th class="text-left p-2">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå</th>
                    <th class="text-left p-2">Preview</th>
                    <th class="text-left p-2">Download</th>
                    <th class="text-left p-2">‡∏•‡∏ö</th>
                </tr>
            </thead>
        <tbody id="fileList">
            <!-- JS ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á -->
        </tbody>
    </table>
    </div>

    </div>

    <!-- Modal Preview -->
    <div id="previewModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-lg max-w-3xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modalTitle" class="font-bold text-lg"></h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 text-2xl cursor-pointer">&times;</button>
            </div>
            <div id="modalBody" class="p-4 overflow-auto flex-1 flex items-center justify-center">
            </div>
        </div>
    </div>

    <script>
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        }
        // --- ‡πÄ‡∏ä‡πá‡∏Ñ token ---
    const token = localStorage.getItem('token');
    if (!token) {
    window.location.href = '/index.html';
    }
    const tokenname = localStorage.getItem('tokenname');
    document.getElementById('tokenname').textContent = 'File Manager -' + tokenname;

    function loadFiles(){
        fetch('/files',{
            headers: { 'Authorization': 'Bearer ' + token}
        })
        .then(res => res.json())
        .then(files =>{
            const fileList =document.getElementById('fileList');
            fileList.innerHTML = '';
            files.forEach(file =>{
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50 transition';
                tr.innerHTML = `
                    <td class="p-2">${file.filename}</td>
                    <td class="p-2">
                        <button onclick="previewFile('${file.filename}')" class="text-purple-600 hover:underline cursor-pointer">Preview</button>
                    </td>
                    <td class="p-2">
                        <button onclick="download('${file.filename}')" class="text-blue-600 hover:underline cursor-pointer">Download</button>
                    </td>
                    <td class="p-2">
                        <button onclick="deleteFile('${file.filename}')" class="text-red-600 hover:underline cursor-pointer">‡∏•‡∏ö</button>
                    </td>
                `;
                fileList.appendChild(tr);
            })

        })
    }
    loadFiles();

        document.getElementById('uploadBtn').addEventListener('click',() =>{
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0]
            if (!file) return alert('‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô');
            const formData = new FormData();
            formData.append('file',file);
            fetch('/upload',{
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token},
                body: formData
            })
            .then(res => res.json())
            .then(data =>{
                alert(data.message);
                loadFiles();
                fileInput.value = '';
                document.getElementById('preview').classList.add('hidden');
            })
        })

        async function download(filename) {
            const res = await fetch('/download/' + filename,{
                headers: { 'Authorization':  'Bearer ' + token}
            });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        async function deleteFile(filename){
            if (!confirm('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå ' + filename + ' ‡∏à‡∏£‡∏¥‡∏á‡πÜ‡πÑ‡∏´‡∏°?')) return;
            await fetch('/files/' + filename, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token}
            });
            loadFiles();
        }

        // --- Preview ‡∏Å‡πà‡∏≠‡∏ô upload (‡∏£‡∏π‡∏õ / PDF / ‡∏≠‡∏∑‡πà‡∏ô‡πÜ) ---
        document.getElementById('fileInput').addEventListener('change', (e) =>{
            const file = e.target.files[0];
            const preview = document.getElementById('preview');
            const previewPdf = document.getElementById('previewPdf');
            const previewOther = document.getElementById('previewOther');

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å preview ‡∏Å‡πà‡∏≠‡∏ô
            preview.classList.add('hidden');
            previewPdf.classList.add('hidden');
            previewOther.classList.add('hidden');

            if (!file) return;

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) =>{
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                previewPdf.src = URL.createObjectURL(file);
                previewPdf.classList.remove('hidden');
            } else {
                document.getElementById('previewFilename').textContent = file.name;
                previewOther.classList.remove('hidden');
            }
        });

        // --- Preview ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å server (modal) ---
        async function previewFile(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const modal = document.getElementById('previewModal');
            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').textContent = filename;

            const url = '/download/' + filename;
            const headers = { 'Authorization': 'Bearer ' + token };

            if (['jpg','jpeg','png','gif','webp','svg'].includes(ext)) {
                const res = await fetch(url, { headers });
                const blob = await res.blob();
                const blobUrl = URL.createObjectURL(blob);
                modalBody.innerHTML = `<img src="${blobUrl}" class="max-w-full max-h-[70vh] rounded-lg">`;
            } else if (ext === 'pdf') {
                const res = await fetch(url, { headers });
                const blob = await res.blob();
                const blobUrl = URL.createObjectURL(blob);
                modalBody.innerHTML = `<iframe src="${blobUrl}" class="w-full h-[70vh] rounded-lg border"></iframe>`;
            } else {
                modalBody.innerHTML = `
                    <div class="text-center p-8">
                        <span class="text-6xl">üìÑ</span>
                        <p class="text-gray-600 mt-4 text-lg">${filename}</p>
                        <p class="text-gray-400 text-sm mt-2">‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ preview ‡πÑ‡∏î‡πâ</p>
                    </div>
                `;
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('modalBody').innerHTML = '';
        }

        // --- Filter ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå ---
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const rows = document.getElementById('fileList').querySelectorAll('tr');
            rows.forEach(row => {
                const filename = row.querySelector('td').textContent.toLowerCase();
                row.style.display = filename.includes(keyword) ? '' : 'none';
            });
        });
    </script>
</body>
</html>
