<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Manager - Login</title>
  <!-- Tailwind CSS — ใช้จัด style โดยไม่ต้องเขียน CSS เอง -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<!--
  bg-gray-100    = พื้นหลังสีเทาอ่อน
  min-h-screen   = สูงเต็มจอ
  flex + items-center + justify-center = จัดทุกอย่างให้อยู่กลางจอ
-->
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <!--
    ==================== ส่วนที่ 1: HTML (โครงสร้างหน้า Login) ====================
    - กล่องขาว ตรงกลางจอ มี form ให้กรอก username + password
  -->
  <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">

    <!-- หัวข้อ -->
    <h1 class="text-2xl font-bold text-center mb-6">File Manager</h1>

    <!--
      ข้อความ error — ปกติซ่อนไว้ด้วย class "hidden"
      พอ login ไม่ผ่าน JS จะเอา hidden ออก ให้มันแสดง
    -->
    <p id="errorMsg" class="text-red-500 text-sm text-center mb-4 hidden"></p>

    <!--
      form ใช้ id="loginForm" เพื่อให้ JS จับ event submit ได้
      class="space-y-4" = เว้นระยะห่างระหว่าง element ข้างใน 4 หน่วย
    -->
    <form id="loginForm" class="space-y-4">

      <!-- ช่อง Username -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input
          type="text"
          id="username"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="กรอก username"
          required
        />
        <!--
          required = ถ้าไม่กรอก browser จะแจ้งเตือนให้กรอกก่อน submit
          focus:ring-2 focus:ring-blue-500 = ตอนคลิกที่ช่อง จะมีกรอบสีฟ้า
        -->
      </div>

      <!-- ช่อง Password -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input
          type="password"
          id="password"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="กรอก password"
          required
        />
        <!-- type="password" = ซ่อนตัวอักษรเป็นจุด ●●●●● -->
      </div>

      <!-- ปุ่ม Login -->
      <button
        type="submit"
        class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition cursor-pointer"
      >
        เข้าสู่ระบบ
      </button>
      <!--
        type="submit" = กดแล้ว form จะ fire event "submit"
        hover:bg-blue-700 = ตอนเอาเมาส์ชี้จะเข้มขึ้น
        transition = เปลี่ยนสีแบบ smooth
      -->
    </form>
  </div>

  <!--
    ==================== ส่วนที่ 2: JavaScript (ตรรกะการ Login) ====================
  -->
  <script>
    // URL ของ server ที่เราจะส่ง request ไป
    const serverUrl = 'http://localhost:5000';

    // ─────────────────────────────────────────
    // เช็คว่า login อยู่แล้วหรือยัง?
    // ─────────────────────────────────────────
    // localStorage = ที่เก็บข้อมูลถาวรในฝั่ง browser (ปิดแล้วเปิดใหม่ก็ยังอยู่)
    // เราเก็บข้อมูล user เป็น JSON string เช่น '{"id":1,"username":"admin","role":"admin"}'
    // JSON.parse() = แปลง string กลับเป็น object
    const user = JSON.parse(localStorage.getItem('user'));

    if (user) {
      // ถ้ามี user อยู่แล้ว = login แล้ว → redirect ไปหน้าที่ควรไปเลย
      // ไม่ต้อง login ซ้ำ
      if (user.role === 'admin') {
        window.location.href = '/page/admin/dashboard.html';
      } else {
        window.location.href = '/page/user/home.html';
      }
    }

    // ─────────────────────────────────────────
    // จับ event เมื่อกด submit form
    // ─────────────────────────────────────────
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      // e.preventDefault() = กัน browser ไม่ให้ reload หน้า
      // ปกติ form submit จะ reload หน้า แต่เราไม่อยากให้ reload
      // เพราะเราจะจัดการเองด้วย JavaScript (Fetch API)
      e.preventDefault();

      // ดึงค่าที่ user พิมพ์
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorMsg = document.getElementById('errorMsg');

      try {
        // ─────────────────────────────────────
        // ส่ง POST request ไป server ด้วย Fetch API
        // ─────────────────────────────────────
        // นี่คือสิ่งที่โจทย์บอกว่า "ใช้ Fetch API ส่งผ่าน HTTP POST"
        const res = await fetch(`${serverUrl}/login`, {
          method: 'POST',                              // ใช้ method POST
          headers: { 'Content-Type': 'application/json' }, // บอก server ว่าส่ง JSON มา
          body: JSON.stringify({ username, password })  // แปลง object เป็น JSON string แล้วส่ง
        });
        // JSON.stringify({ username, password })
        // จะได้ เช่น '{"username":"admin","password":"admin123"}'

        // แปลง response จาก server เป็น object
        const data = await res.json();

        // ─────────────────────────────────────
        // เช็คผลลัพธ์
        // ─────────────────────────────────────
        if (!res.ok) {
          // res.ok = false เมื่อ status code ไม่ใช่ 200 (เช่น 401 = login ไม่ผ่าน)
          errorMsg.textContent = data.error;    // ใส่ข้อความ error
          errorMsg.classList.remove('hidden');   // เอา hidden ออก ให้มันแสดง
          return; // จบ ไม่ทำต่อ
        }

        // ─────────────────────────────────────
        // Login สำเร็จ!
        // ─────────────────────────────────────
        // เก็บข้อมูล user ลง localStorage (เพื่อใช้ในหน้าอื่น)
        // data.user = { id: 1, username: "admin", role: "admin" }
        localStorage.setItem('user', JSON.stringify(data.user));

        // redirect ไปหน้าที่ตรงกับ role
        if (data.user.role === 'admin') {
          window.location.href = '/page/admin/dashboard.html';
        } else {
          window.location.href = '/page/user/home.html';
        }

      } catch (err) {
        // ถ้า fetch ไม่สำเร็จเลย (เช่น server ไม่ได้เปิด)
        errorMsg.textContent = 'ไม่สามารถเชื่อมต่อ Server ได้';
        errorMsg.classList.remove('hidden');
      }
    });
  </script>

</body>
</html>
